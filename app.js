clouda.lightInit({ak:"9ZBrTBViAjqGidGBZQjoGxgw",module:["device"]});var getDeviceId=function(){clouda.device.device.getImei({onfail:function(){},onsuccess:function(e){window._imeiDeviceId=e}})};getDeviceId(),angular.module("ionicApp",["ionic","angular-websocket"]).config(["WebSocketProvider",function(e){e.uri("ws://172.16.121.64:9902")}]).run(["$rootScope","WebSocket","apiHelper","$ionicPopup","$timeout","$state",function(e,n,t,a,i,o){window._APIHOST="http://42.96.165.176:9091",window._deviceId=localStorage.getItem("deviceId")||"acb1406978998599",window._imeiDeviceId&&(window._deviceId=window._imeiDeviceId),e._deviceId=window._deviceId,e.getResturant=function(){t("getResturant",{slug:"3wcoffee"},{}).then(function(n){console.log(n),e.loading&&e.loading.hide(),e.resturantInfo=n,window._availableTableTypes=_.uniq(_.pluck(n.tables,"capacity")),e._availableTableTypes=window._availableTableTypes})},e.$on("$stateChangeStart",function(n,t,a,i){"tabs.profile-detail"===i.name&&(e._hasRead=!0),"tabs.argue-detail"===t.name?$(".tabs").hide():$(".tabs").show()}),e.$on("chat.new",function(n,t){o.is("tabs.argue-detail")||(e._hasRead=!1,t.timestamp=new Date,e._unreadChats=e._unreadChats?e._unreadChats:[],e._unreadChats.push(t))}),e.$on("biz",function(n,t){e._hasRead=!1,t.type="biz",t.timestamp=new Date,e._unreadChats=e._unreadChats?e._unreadChats:[],e._unreadChats.push(t)}),e.$on("jump.response",function(){var e=a.alert({title:"恭喜",template:"您的换位请求已经被答应"});e.then(function(){o.go("tabs.argue",{},{reload:!0})})}),e.$on("jump.request",function(e,i){var r=a.confirm({title:"换位请求",template:_.template("<%= nickName %>(排位号：<%= preOrderNum %>)，花<%= money %>元，请求和您换位置，你同意吗？",i)});r.then(function(e){e?(n.send(JSON.stringify({type:"jump.response",data:{toDeviceId:i.fromDeviceId}})),t("changeOrder",{params:{fromDeviceId:i.fromDeviceId,toDeviceId:i.toDeviceId,changeOrderMoney:12}}).then(function(){o.go("tabs.argue",{},{reload:!0})}),console.log("You are sure")):console.log("You are not sure")})}),n.onopen(function(){console.log("connection"),n.send(JSON.stringify({type:"registry",data:{fromDeviceId:window._deviceId}}))}),n.onerror=function(e){console.log("connection closed"),console.log(e)},n.onclose=function(e){console.log("connection closed"),console.log(e)},n.onmessage(function(n){console.log("message: ",n.data);var t=JSON.parse(n.data);if("chat"===t.type)e.$broadcast("chat.new",t.data);else{if(!t.type)return;e.$broadcast(t.type,t.data)}})}]),angular.module("ionicApp").run(["$templateCache",function(e){e.put("templates/argue-detail.html",'<ion-view title="聊天" ng-controller="argueDetailCtrl" class="argue_detail">\n  <ion-content class="chatpanel padding">\n    <table class="chat-status">\n      <tr>\n         <td class="user">\n          对方：{{_arguePeople.nickName}} 共 {{_arguePeople.customerNum}} 人\n        </td>\n         <td class="status">\n          <button\n            ng-class="{\'onefun-button-useless\': !agree.other,\n             \'onefun-button\': argree.other}">{{agree.other?\'已同意\':\'未同意\'}}</button>\n        </td>\n      </tr>\n      <tr>\n         <td class="user">我：</td>\n         <td class="status">\n           <button ng-class="{\'onefun-button-useless\': !agree.self,\n             \'onefun-button\': argree.self}"\n            ng-disabled="agree.self"\n            ng-click="agreeTojoin()">\n            {{agree.self?\'已同意\':\'未同意\'}}\n          </button>\n         </td>\n      </tr>\n    </table>\n\n    <ol class="discussion chat-list">\n      <li\n        ng-repeat="i in msgList track by $index"\n        ng-class="getMsgClass(i)">\n        <div class="avatar">\n          <div random-avatar></div>\n        </div>\n        <div class="messages">\n          <p>{{i.msg}}</p>\n        </div>\n      </li>\n    </ol>\n    <div class="chat-input">\n      <input type="text" placeholder="输入内容"\n        ng-model="chatText" class="text" ng-keydown="keydownHandler($event)">\n      <button class="send" ng-click="postMsg()">发送</button>\n    </div>\n  </ion-content>\n</ion-nav-view>'),e.put("templates/argue-finish.html",'<ion-view title="预约成功" class="argue_finish">\n  <ion-content class="padding home_finish">\n    <h1 class="home_finishlogo">\n      拼桌成功！\n    </h1>\n    <div class="home_finishcontent">\n      <h2 class="content_num">您的排队号调整为：<b>{{_mergeOrderInfo.preOrderNum}}</b></h2>\n      <div class="content_detail">\n        <h3 class="content_detail">对方信息：</h3>\n        <ul class="content_ul">\n          <li><span>昵称：<b>{{_mergeOrderInfo.other.nickName}}</b></span></li>\n          <li><span>手机：<b>\n            <!-- trigger a real phone call -->\n            <a href="tel:{{i.phoneNum}}">{{_mergeOrderInfo.other.phoneNum}}</a>\n          </b></span></li>\n        </ul>\n        <span class="content_tip">请尽快与对方取得联系哦~</span>\n        <a class="button button-small onefun-button-yellow"\n          ui-sref="tabs.argue">回到首页</a>\n      </div>\n    </div>\n  </ion-content>\n</ion-nav-view>'),e.put("templates/argue-list.html",'<ion-view title="可拼" ng-controller="argueListCtrl">\n  <ion-content class="padding tablepooling tplist">\n    <h2 class="tplist_title">\n      <span class="title_text">您可以发起拼桌</span>\n      <button class="button button-small onefun-button" ui-sref="tabs.order">发起我的拼桌</button>\n    </h2>\n    <ul class="tplist_ul">\n      <li ng-hide="availableList" class="x-list_none">\n        <h3 class="none">暂无可拼！</h3>\n      </li>\n\n      <li class="tplist_list tplist_list_first clearfix" ng-show="availableList"\n        ng-repeat="i in availableList|filter: {deviceId: _deviceId}">\n        <div class="tp_num">\n          <span class="tp_num_info">{{i.tableCapacity}}缺\n          <b>{{i|inferLeftCount}}</b></span>\n          <span class="tp_num_code">{{i.preOrderNum}}</span>\n        </div>\n        <div class="tp_content clearfix">\n          <div class="tp_content_c">\n            <h3 class="title">\n              {{i.nickName}} 共{{i.customerNum}}人\n              <a class="button button-small onefun-button-yellow">我的拼桌</a>&nbsp;\n              &nbsp;<a class="button button-small onefun-button-yellow" ng-show="i.isAccept == 2">已拼桌</a>\n            </h3>\n            <span class="info"><i class="icon ion-quote"></i>\n              可拼 - {{i.tableCapacity}}人桌，\n              {{i|inferLeftStr}}</span>\n          </div>\n          <div class="tp_content_r" ng-hide="i.isAccept == 2">\n            <button class="button button-small onefun-button-green"\n              ng-click="goSelfSetting()">设置</button>\n          </div>\n          <div class="tp_content_b">\n            “{{i.introText||\'还没设置....\'}}”\n          </div>\n        </div>\n      </li>\n\n      <li class="tplist_list clearfix"\n        ng-repeat="i in availableList|filter: {deviceId: \'!\'+_deviceId}|orderBy:\'preOrderNum\':false">\n        <div class="tp_num">\n          <span class="tp_num_info">{{i.tableCapacity}}缺\n          <b>{{i|inferLeftCount}}</b></span>\n          <span class="tp_num_code">{{i.preOrderNum}}</span>\n        </div>\n        <div class="tp_content clearfix">\n          <div class="tp_content_c">\n            <h3 class="title">\n              {{i.nickName}} 共{{i.customerNum}}人\n              <a class="button button-small onefun-button-yellow" ng-show="i.isAccept == 2">已拼桌</a>\n            </h3>\n            <span class="info">\n              <i class="icon ion-quote"></i>\n              可拼 - {{i.tableCapacity}}人桌，\n              {{i|inferLeftStr}}</span>\n          </div>\n          <div class="tp_content_r" ng-hide="i.isAccept == 2">\n            <button class="button button-small onefun-button-green"\n              ng-click="goArgueDetail(i)">联系</button>\n            <button class="button button-small onefun-button-green"\n              ng-click="askJumpQueue(i)"\n              ng-show="canJumpQueeu(i)">插队</button>\n          </div>\n          <div class="tp_content_b">\n            “{{i.introText}}”\n          </div>\n        </div>\n      </li>\n\n    </ul>\n  </ion-content>\n</ion-nav-view>'),e.put("templates/manage-item.html",'      <!-- 修改牌号 -->\n\n      <div class="list">\n        <label class="item item-input">\n          <input type="text" placeholder="人数">\n        </label>\n        <label class="item item-input">\n          <input type="text" placeholder="Last Name">\n        </label>\n        <label class="item item-input">\n          <textarea placeholder="Comments"></textarea>\n        </label>\n      </div>'),e.put("templates/manage-list.html",'<ion-view title="管理界面" ng-controller="manageListCtrl" class="manage_list">\n  <ion-content class="padding tablepooling tplist">\n    <nav class="tplist_nav">\n      <h3 class="tplist_nav_title"></h3>\n      <ul class="tplist_nav_ul clearfix" ng-init="currentFilter=\'\'">\n        <li><button class="button onefun-button-green"\n          ng-click="currentFilter = \'\'"\n          ng-class="{\'onefun-button-active\': (currentFilter == \'\')}">所有</button></li>\n        <li ng-repeat="i in $root._availableTableTypes">\n          <button class="button onefun-button-green"\n            ng-click="$parent.currentFilter = i"\n            ng-class="{\'onefun-button-active\': ($parent.currentFilter == i)}">{{i}}人桌</button>\n        </li>\n      </ul>\n    </nav>\n    <ul class="tplist_ul">\n      <li class="tplist_list clearfix"\n        ng-repeat="i in allOrder|filter:{tableCapacity: currentFilter}" ng-click="showActions(i)">\n        <div class="tp_num">\n          <span class="tp_num_ordercode">{{i.preOrderNum}}</span>\n        </div>\n        <div class="tp_content clearfix">\n          <div class="tp_content_c">\n            <h3 class="title">\n              {{i.nickName}} 共<b>{{i.customerNum}}</b>人\n              <em>{{i.updatedTime|timeago}}</em>\n            </h3>\n            <span class="info">手机号：{{i.phoneNum}}</span>\n            <span class="intro">{{i.introText}}</span>\n            <!-- <span class="detail"><b>拼桌对象：</b>原2010号 张女士 共两人 18888888888</span> -->\n          </div>\n        </div>\n      </li>\n    </ul>\n  </icon-content>\n</icon-view>'),e.put("templates/order-form.html",'      <ion-view title="提交信息" class="order_submit">\n        <ion-content class="home_getinfo padding">\n          <form name="oderForm"\n            ng-submit="submitOrder()">\n            <div class="list list-inset">\n              <label class="item item-input">\n                <input type="number" name="customerNum" required\n                  placeholder="人数:" ng-model="info.customerNum">\n              </label>\n              <label class="item item-input">\n                <input type="text" name="nickName" required\n                  placeholder="称呼:" ng-model="info.nickName">\n              </label>\n              <label class="item item-input">\n                <input type="text" ng-pattern="/^\\d*$/" required name="phoneNum"\n                  placeholder="手机号:" ng-model="info.phoneNum">\n              </label>\n              <ion-toggle\n                ng-hide="info.customerNum === info.tableCapacity"\n                ng-init="info.isAccept=true"\n                ng-model="info.isAccept"\n                ng-checked="info.isAccept">\n                是否接受拼桌\n              </ion-toggle>\n\n            </div>\n            <div class="tip">\n              <div class="tip_warn" ng-hide="info.isAccept">\n                <span class="tip_warn_text">\n                  <b>提示：</b>接受拼桌不影响正常排队，还有机会快速入座，结识新朋友哦~\n                </span>\n              </div>\n\n              <div class="tip_warn" ng-show="info.customerNum">\n                <span class="tip_warn_text" ng-hide="info.tableCapacity">\n                    没那么大的桌子，你们分开吃吧....\n                </span>\n              </div>\n\n              <div class="tip_show"\n                ng-show="info.isAccept && info.customerNum">\n                <span class="tip_show_text" ng-show="info.tableCapacity">\n                  <i class="icon ion-coffee"></i>\n                  自动为您分配：<b>{{info.tableCapacity}}人桌</b>\n                </span>\n\n                <textarea style="height: 69px;"\n                  class="tip_show_textarea" name="introText" required\n                  placeholder="一句话自我介绍" ng-model="info.introText">\n                </textarea>\n              </div>\n\n              <div class="tip_warn" ng-show="info.isAccept">\n                <span class="tip_warn_text" ng-show="oderForm.$error.required">\n                  <b>提示：</b>请先补全相关信息~</div>\n                </span>\n\n                <span class="tip_warn_text" ng-show="orderForm.$invalid">\n                  <b>提示：</b>请先按照要求填写的信息~</div>\n                </span>\n              </div>\n            </div>\n            <div class="padding">\n              <button class="button onefun-button-red"\n                ng-disabled="orderForm.$invalid" type="submit">取号</button>\n            </div>\n          </form>\n        </ion-content>\n      </ion-nav-view>'),e.put("templates/order-info.html",'<ion-view title="预约成功" class="order_info" ng-controller="orderInfoCtrl">\n  <ion-content class="padding home_getlocal">\n    <h1 class="home_shoplogo">\n      <img class="logo" ng-src="{{resturantInfo.img|hostImg}}" />\n    </h1>\n    <div class="home_content">\n      <span class="home_content_item home_local">\n          <i class="icon ion-location"></i>\n          <b class="home_local_info">您现在的位置：{{resturantInfo.name}}</b>\n      </span>\n      <span class="home_content_item home_detail">\n        现在共有<b>{{resturantInfo.preOrderCount}}</b>组，\n        共计<b>{{resturantInfo.preOrderPeopleCount}}</b>人在排队</span>\n      <span class="home_content_item home_numinfo">\n        <dl class="home_numinfo_dl">\n          <dt class="home_numinfo_dt">\n            <span class="home_numinfo_text">排队号：<b>{{preOrderInfo.preOrderNum}}</b></span>\n            <button class="button button-small onefun-button-yellow"\n              ng-click="cancelOrder()">取消排队</button>\n          </dt>\n          <dd class="home_numinfo_dd">\n            <label>称&nbsp;&nbsp;&nbsp;呼：</label><span>{{preOrderInfo.nickName}}(共{{preOrderInfo.customerNum}}人)</span>\n          </dd>\n          <dd class="home_numinfo_dd">\n            <label>手&nbsp;&nbsp;&nbsp;机：</label><span>{{preOrderInfo.phoneNum}}</span>\n          </dd>\n          <dd class="home_numinfo_dd home_numinfo_dd_together"\n            ng-hide="preOrderInfo.customerNum === preOrderInfo.tableCapacity">\n            <label>拼&nbsp;&nbsp;&nbsp;桌：</label>\n            <span>{{preOrderInfo.isAccept?\'接受\': \'不接受\'}}</span>\n            <label class="item-choice-toggle toggle">\n               <input type="checkbox"\n                ng-model="preOrderInfo.isAccept"\n                ng-checked="preOrderInfo.isAccept">\n               <div class="track">\n                 <div class="handle"></div>\n               </div>\n            </label>\n          </dd>\n          <dd class="home_numinfo_dd home_numinfo_dd_intro">\n            <span class="home_numinfo_text">\n              {{preOrderInfo.introText}}\n            </span>\n          </dd>\n        </dl>\n      </span>\n    </div>\n  </ion-content>\n</ion-nav-view>'),e.put("templates/order-location.html",'<ion-view title="One Fun 排队拼桌系统">\n  <ion-content class="home_getnum padding">\n    <h1 class="home_logo">\n      <img class="logo" src="logo.png" />\n    </h1>\n    <div class="home_content">\n      <span class="home_content_item home_local"><i class="icon ion-loading-a"></i>正在定位</span>\n      <span class="home_content_item home_status">您还未取号</span>\n      <span class="home_content_item home_button">\n        <button class="button onefun-button-useless">取号</button>\n      </span>\n    </div>\n  </ion-content>\n</ion-view>'),e.put("templates/order-locationed.html",'<ion-view title="{{resturantInfo.name}}排队系统">\n  <ion-content class="padding home_getlocal">\n    <h1 class="home_shoplogo">\n      <img class="logo" ng-src="{{resturantInfo.img|hostImg}}" />\n    </h1>\n    <div class="home_content">\n      <span class="home_content_item home_local">\n          <i class="icon ion-location"></i>\n          <b class="home_local_info">您现在的位置：{{resturantInfo.name}}</b>\n      </span>\n      <span class="home_content_item home_detail">现在共有<b>{{resturantInfo.preOrderCount}}</b>组，\n        共计<b>{{resturantInfo.preOrderPeopleCount}}</b>人在排队</span>\n      <span class="home_content_item home_status">您还未取号…</span>\n      <span class="home_content_item home_button">\n        <a class="button onefun-button"\n          ui-sref="tabs.order-form">取号</a>\n      </span>\n    </div>\n  </ion-content>\n</ion-nav-view>'),e.put("templates/profile-detail.html",'<ion-view title="我的消息" ng-controller="profileDetailCtrl">\n  <ion-content class="padding setting">\n    <ul class="setting_ul">\n      <li ng-hide="unreadChats" class="x-list_none">\n        <h3 class="none">暂无消息！</h3>\n      </li>\n      <li class="setting_list clearfix"\n        ng-show="unreadChats" ng-repeat="i in unreadChats">\n        <!-- <span class="tp_num"><em class="msg">2</em></span> -->\n        <div ng-switch on="i.type">\n\n          <a ng-switch-when="biz">\n            <div class="tp_content_c">\n              <h3 class="title">商家消息：</h3>\n              <span class="info"><i class="icon ion-quote"></i>{{i.msg}}</span>\n            </div>\n          </a>\n\n          <a ng-switch-default class="tp_content clearfix"\n          ng-click="goArgueDetail(i.from)">\n            <div class="tp_content_c">\n              <h3 class="title">{{i.from.nickName}}说：\n                <span>拍位号({{i.from.preOrderNum}}) 共{{i.from.customerNum}}人</span>\n              </h3>\n              <span class="info"><i class="icon ion-quote"></i>{{i.msg}}</span>\n            </div>\n            <div class="tp_content_r">\n              <span class="time">{{i.timestamp|timeago}}</span>\n            </div>\n          </a>\n        </div>\n      </li>\n    </ul>\n  </ion-content>\n</ion-view>'),e.put("templates/tabs.html",'<ion-tabs class="tabs-icon-top tabs-positive">\n\n  <ion-tab title="取号" icon="ion-home" href="#/tab/order">\n    <ion-nav-view name="order-tab"></ion-nav-view>\n  </ion-tab>\n\n  <ion-tab title="拼桌" icon="ion-person-add" href="#/tab/argue">\n    <ion-nav-view name="argue-tab"></ion-nav-view>\n  </ion-tab>\n\n  <ion-tab title="我的消息" icon="ion-chatboxes" ui-sref="tabs.profile" badge="_hasRead ? \'0\' :_unreadChats.length">\n    <ion-nav-view name="profile-tab"></ion-nav-view>\n  </ion-tab>\n</ion-tabs>')}]),angular.module("ionicApp").factory("apiHelper",["$http",function(e){function n(e,n){return n?(_.each(n,function(n){e=e.indexOf(":")>-1?e.replace(/:[^/]+/,n):e+"/"+n}),e):e}function t(t,o){arguments=_.toArray(arguments);var r=a[arguments.shift()],s=r.split(" ")[0];if(o=_.isObject(_.last(arguments))?arguments.pop():{},_.isObject(_.last(arguments))&&(/(DELETE)|(GET)/.test(s)?o.params=arguments.pop():o.data=arguments.pop()),!r)throw new Error("Endpint "+t+"Does Not Exist!");return e(_.extend({method:s,url:i+n(r.split(" ")[1],arguments)},o))}var a={},i="/api";return t.config=function(e){a=_.extend(a,e)},t.configByType=function(e,n){var t={},n=n||{prefix:""};_.each(e.add,function(e){t["add"+_.slugify(e)]="POST "+n.prefix+e}),_.each(e.del,function(e){t["del"+_.slugify(e)]="DELETE "+n.prefix+e}),_.each(e.list,function(e){t["get"+_.slugify(e)+"List"]="GET "+n.prefix+e+"s"}),_.each(e.item,function(e){t["get"+_.slugify(e)]="GET "+n.prefix+e}),this.config(t)},t}]).factory("apiHelperInterceptor",["$q",function(e){return $notice=console,$notice.success=console.log,{request:function(e){return e.originUrl=e.url,e.url.indexOf("api")>-1&&(e.url=window._APIHOST+e.url),e},responseError:function(n){return $notice.error("error-"+n.status+": "+(n.config.url||"")+(n.data.msg||", 接口出问题啦!")),e.reject(n)},response:function(e){return e.config.url.indexOf("/api/")>-1?("POST"===e.config.method&&$notice.success("操作成功！"),e.data):e}}}]).config(["$httpProvider",function(e){e.interceptors.push("apiHelperInterceptor")}]),angular.module("ionicApp").config(["$stateProvider","$urlRouterProvider",function(e,n){e.state("tabs",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tabs.order",{url:"/order",views:{"order-tab":{templateUrl:"templates/order-location.html",controller:"orderLocationCtrl"}}}).state("tabs.order-locationed",{url:"/order-locationed",views:{"order-tab":{templateUrl:"templates/order-locationed.html",controller:"orderLocationedCtrl"}}}).state("tabs.order-form",{url:"/order-form",views:{"order-tab":{templateUrl:"templates/order-form.html",controller:"orderFormCtrl"}}}).state("tabs.order-info",{url:"/order-info",views:{"order-tab":{templateUrl:"templates/order-info.html",controllder:"orderInfoCtrl"}}}).state("tabs.argue",{url:"/argue",views:{"argue-tab":{templateUrl:"templates/argue-list.html",controllder:"argueListCtrl"}}}).state("tabs.argue-detail",{url:"/argue-detail",views:{"argue-tab":{templateUrl:"templates/argue-detail.html",controllder:"argueDetailCtrl"}}}).state("tabs.argue-finish",{url:"/argue-finish",views:{"argue-tab":{templateUrl:"templates/argue-finish.html",controllder:"argueFinishCtrl"}}}).state("tabs.profile",{url:"/profile",views:{"profile-tab":{templateUrl:"templates/profile-detail.html",controllder:"profileDetailCtrl"}}}).state("tabs.manage-list",{url:"/manage-list",views:{"argue-tab":{templateUrl:"templates/manage-list.html",controllder:"manageListCtrl"}}}).state("tabs.manage-item",{url:"/manage-item",views:{"argue-tab":{templateUrl:"templates/manage-item.html",controllder:"manageItemCtrl"}}}),n.otherwise("/tab/order")}]),angular.module("ionicApp").run(["apiHelper",function(e){e.config({getRestaurantList:"GET /restaurant/list",getResturant:"GET /restaurant",postPreOrderInfo:"POST /preorder",getAvailableList:"GET /preorder/list",mergeOrder:"POST /mergeorder",changeOrder:"POST /changeorder",updateOrder:"POST /updateorder"})}]),angular.module("ionicApp").directive("randomAvatar",function(){var e="http://wilee.me/image/portrait/portrait_"+Math.ceil(9*Math.random())+".jpg";return{restrict:"EAC",template:'<img ng-src="{{imgSrc}}" />',link:function(n){n.imgSrc=e}}}),angular.module("ionicApp").filter("hostImg",function(){return function(e){return e?window._APIHOST+"/"+e:"logo.png"}}).filter("inferLeftCount",function(){return function(e){return e.tableCapacity-e.customerNum}}).filter("inferLeftStr",function(){return function(e){var n=e.tableCapacity-e.customerNum;return 0===n?"已满":1===n?"可接受1人":"可接受1-"+n+"人"}}).filter("timeago",function(){return function(e,n,t){if(!e)return"never";if(n||(n=Date.now()),angular.isDate(e)?e=e.getTime():"string"==typeof e&&(e=new Date(e).getTime()),angular.isDate(n)?n=n.getTime():"string"==typeof n&&(n=new Date(n).getTime()),"number"==typeof e&&"number"==typeof n){var a=Math.abs((n-e)/1e3),i=[],o=60,r=3600,s=86400,l=604800,c=31556926,u=315569260;return i=o>=a?["",t?"刚刚":"1分钟"]:60*o>a?[Math.round(Math.abs(a/o)),"分钟"]:24*r>a?[Math.round(Math.abs(a/r)),"小时"]:7*s>a?[Math.round(Math.abs(a/s)),"day"]:52*l>a?[Math.round(Math.abs(a/l)),"week"]:10*c>a?[Math.round(Math.abs(a/c)),"year"]:100*u>a?[Math.round(Math.abs(a/u)),"decade"]:["","很久之前"],i[1]+=0===i[0]||i[0]>1?"s":"",i=i.join(" "),t===!0?i:n>=e?i+"前":"in "+i}}}),angular.module("ionicApp").controller("orderLocationCtrl",["$scope","$rootScope","$ionicLoading","apiHelper","$timeout","$state",function(e,n,t,a,i,o){n.loading=t.show({content:"正在定位请稍后...",showBackdrop:!1}),i(function(){o.go("tabs.order-locationed"),n.loading.hide()},1500)}]).controller("orderLocationedCtrl",["$rootScope",function(e){e.getResturant()}]).controller("orderFormCtrl",["$scope","$rootScope","$ionicPopup","$state","apiHelper","WebSocket",function(e,n,t,a,i){function o(){var e=t.alert({title:"预约成功！",template:"您可以到拼桌页面，查找附近的人，一起来."});e.then(function(){a.go("tabs.order-info")})}function r(e){return window._availableTableTypes||(window._availableTableTypes=[4,6,8]),_.min(_.filter(window._availableTableTypes,function(n){return n>=e}))}e.info=window._stateParam?window._stateParam:JSON.parse(localStorage.getItem("orederInfo"))||{},window._myselfOrder&&(e.info=_myselfOrder),e.$watch("info.customerNum",function(n){var t=r(n);e.info.tableCapacity=1/0!==t?t:null}),e.submitOrder=function(){e.info.deviceId=window._deviceId,e.info.tableCapacity&&(e.info.isAccept=e.info.tableCapacity===e.info.customerNum?0:e.info.isAccept?1:0,i("postPreOrderInfo",{data:e.info}).then(function(t){o(),n.preOrderInfo=t,localStorage.setItem("orederInfo",JSON.stringify(_.pick(e.info,"nickName","isAccept","introText")))}))}}]).controller("orderInfoCtrl",["$scope","$rootScope","apiHelper","$state",function(e,n,t,a){n.preOrderInfo||window._myselfOrder&&(n.preOrderInfo=_myselfOrder),n.resturantInfo||n.getResturant(),e.cancelOrder=function(){t("updateOrder",{params:{status:1,deviceId:_deviceId}}).then(function(){a.go("tabs.order")})}}]),angular.module("ionicApp").controller("argueListCtrl",["$scope","$rootScope","$state","apiHelper","WebSocket","$ionicPopup","$timeout","$interval",function(e,n,t,a,i,o){function r(){a("getAvailableList").then(function(t){e.availableList=_.isArray(t)?t||[]:[],n.availableList=t,e.myselfOrder=_.filter(t,function(e){return e.deviceId===window._deviceId?!0:!1})[0],e.canJumpQueeu=function(n){return e.myselfOrder&&e.myselfOrder.preOrderNum>n.preOrderNum&&e.myselfOrder.tableCapacity===n.tableCapacity?!0:!1}})}e.goArgueDetail=function(a){e.myselfOrder||o.alert({title:"出错啦",template:"请您先预约单号"});var i=_.min([a.preOrderNum,e.myselfOrder.preOrderNum]),r=_.filter([a,e.myselfOrder],function(e){return e.preOrderNum===i})[0],s=a.customerNum+e.myselfOrder.customerNum;s<=r.tableCapacity?(n._arguePeople=a,t.go("tabs.argue-detail")):o.alert({title:"出错啦",template:"您不满足拼桌条件"})},e.goSelfSetting=function(){window._myselfOrder=e.myselfOrder,t.go("tabs.order-form")},e.askJumpQueue=function(n){o.show({template:'<input type="number" ng-model="$parent.queueMoney">',title:"申请换号",subTitle:"您可以输入报酬以申请靠前队伍喔",scope:e,buttons:[{text:"Cancel"},{text:"<b>确定</b>",type:"button-positive",onTap:function(t){return e.queueMoney?e.sendJumpCmd(e.queueMoney,n.deviceId):void t.preventDefault()}}]})},e.sendJumpCmd=function(n,t){i.send(JSON.stringify({type:"jump.request",data:{money:n,nickName:e.myselfOrder.nickName,preOrderNum:e.myselfOrder.preOrderNum,fromDeviceId:window._deviceId,toDeviceId:t}}))},r()}]).controller("argueDetailCtrl",["$scope","$rootScope","WebSocket","$timeout","$ionicPopup","apiHelper","$state",function(e,n,t,a,i,o,r){a(function(){$(".tabs").hide(),$(".chatpanel").removeClass("has-tabs").find(".scroll").css("min-height","100%"),$(".chat-input").css("position","fixed"),$(".chatpanel .chat-list").css({overflow:"scroll",height:$(".chatpanel .scroll").height()-$(".chat-status").height()-$(".chat-input").height()})}),e.msgList=[],e.keydownHandler=function(n){13===n.keyCode&&e.postMsg()},e.postMsg=function(){t.send(JSON.stringify({type:"chat",data:{fromDeviceId:window._deviceId,toDeviceId:n._arguePeople.deviceId,msg:e.$$childTail.chatText||"聊聊，我们来拼餐？"}})),e.$$childTail.chatText="",-1===navigator.userAgent.indexOf("Chrome")&&$(".chat-input input").blur()},e.$on("chat.new",function(n,t){console.log(t),e.msgList.push(t),$(".chatpanel .chat-list")[0].scrollTop=12e8}),e.agree={},e.$on("agree",function(){e.agree.other=!0}),e.agreeTojoin=function(){t.send(JSON.stringify({type:"agree",data:{toDeviceId:n._arguePeople.deviceId}})),e.agree.self=!0},e.$watch("agree",function(n){n&&n.other&&n.self&&e.mergeOrder()},!0),e.mergeOrder=function(){o("mergeOrder",{params:{fromDeviceId:window._deviceId,toDeviceId:n._arguePeople.deviceId}}).then(function(e){n._mergeOrderInfo={preOrderNum:e.preOrderNum,other:n._arguePeople},r.go("tabs.argue-finish")},function(){i.alert({title:"合并订单失败",template:"你们可以接着聊天！"})})},e.getMsgClass=function(e){return e.fromDeviceId===window._deviceId?"self":"other"}}]).controller("argueFinishCtrl",["$scope","$rootScope",function(e,n){e.i=n._mergeOrderInfo}]),angular.module("ionicApp").controller("profileDetailCtrl",["$scope","$rootScope","apiHelper","$state",function(e,n,t,a){function i(e){return _.filter(n.availableList,function(n){return n.deviceId===e?!0:!1})[0]}function o(){e.unreadChats=_.map(n._unreadChats,function(e){return"biz"===e.type?e:{from:i(e.fromDeviceId),timestamp:e.timestamp,msg:e.msg}})}n.availableList?o():t("getAvailableList").then(function(e){n.availableList=e,o()}),e.goArgueDetail=function(e){n._arguePeople=e,a.go("tabs.argue-detail")},n.$watch("_unreadChats",function(e){e&&o()})}]).controller("manageListCtrl",["$scope","$ionicActionSheet","$state","$rootScope","apiHelper",function(e,n,t,a,i){console.log("manageListCtrl"),a.getResturant(),i("getAvailableList",{params:{type:"all"}}).then(function(n){e.allOrder=n}),e.showActions=function(){a._targetCustomer=a.targetCustomer,n.show({buttons:[{text:"已上桌"},{text:"修改"}],destructiveText:"取消排号",cancelText:"Cancel",cancel:function(){console.log("取消")},buttonClicked:function(e){return 0===e&&i("updateOrder",{params:{status:2,deviceId:_deviceId}}).then(function(){t.reload()}),1===e&&(window._stateParam=a._targetCustomer,t.go("tabs.order-form")),!0},destructiveButtonClicked:function(){return console.log("DESTRUCT"),i("updateOrder",{params:{status:1,deviceId:_deviceId}}).then(function(){t.reload()}),!0}})}}]),angular.bootstrap(document,["ionicApp"]);